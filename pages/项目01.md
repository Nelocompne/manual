public:: true
更新时间:: [[Jan 6th, 2024]]

- # 代理节点——基于Xray和Nginx的全Docker容器服务器搭建
- ## 什么情况下你应该继续阅读该项目？
	- 熟练掌握 [[Docker]] [[Docker Compose]] [[v2ray]]/ [[Xray]] 。
	- 熟练掌握 [[Linux]] [[VPS]]服务器运维 [[Web]]建站。
	- 遵守您所处当前所在的法律，该项目的所有内容将用于帮助您学习及参考。
- ## 准备
	- 服务器配置满足基础工作即可，通常CPU 1核 RAM 1G，带宽没有限制，能正常工作即可。
	- 使用的系统由您的服务器决定，如果是VPS供应商提供。如果您是个人用户推荐选择 [[Ubuntu]]或者 [[Debian]]，这二者提供最新的软件包服务以及更易于使用。如果你是企业用户，出于稳定性考虑可以选择 [[Redhat]]或 [[CentOS]]，但这会付出更高的维护成本。
	- 在管理VPS上，为了安全和便捷，我们在创建服务器时不会创建root密码，而是直接添加 [[SSH]] 密钥用于登录。
	- 当你已经创建并通过 [[SSH]]密钥登录服务器后，习惯上可以更新一次软件包，此时请检查您当前的root使用方式，部分VPS供应商提供`root`用户登录，需要提权的命令可以直接运行，如果VPS供应商提供的不是`root`用户登录，如`ubuntu` `opc`...等，需要提权的命令前需要加上`sudo`方可执行。
	- 然后安装 [[Docker]]，该项目大量依赖该工具。安装方式推荐直接使用 [[Docker]]的官方[GitHub - docker/docker-install: Docker installation script](https://github.com/docker/docker-install)。之后还可以为你的系统安装一些常用的工具，`tmux` `neofetch` `htop` 等等。这边额外推荐一个小工具用于管理 [[Docker]]服务： https://github.com/jesseduffield/lazydocker
	- 大部分VPS供应商提供的系统会默认开启防火墙，防火墙通常由两部分组成，第一个部分由VPS供应商的控制台面板上管理，第二个部分是系统自带提供的。该项目需要向外部提供网络服务，请确保在VPS控制面板上配置`80` `8080` `443`端口已向外公开。而系统自带的防火墙需要关闭或者开放服务端口。参考文章 [Oracle开放全部端口并关闭防火墙 - 清~幽殇 (isedu.top)](https://isedu.top/index.php/archives/33/)：
		- `sudo iptables -P INPUT ACCEPT && sudo iptables -P FORWARD ACCEPT && sudo iptables -P OUTPUT ACCEPT && sudo iptables -F`
		- 该命令执行后会关闭系统自带的防火墙，但是会在服务器关机或重启后重新恢复，此时需要你手动再次执行一遍即可。
		- 额外参考文章 [Vultr默认开启22端口，其他端口都不通的解决办法 | MacGeeker](https://macgeeker.com/linux/vultr-config/)。
	- 开启 [[BBR]] 加速算法。参考：
		- ```shell
		  echo net.core.default_qdisc=fq >> /etc/sysctl.conf
		  echo net.ipv4.tcp_congestion_control=bbr >> /etc/sysctl.conf
		  sysctl -p
		  ```
	- 制作或下载一个 [[html]]静态页面，如果没有选择可以选择模板 [GitHub - kuzan-ux/Anime-world: https://kuzan-ux.github.io/Anime-world/](https://github.com/kuzan-ux/Anime-world) 或 [GitHub - WenqiOfficial/StudyWithMiku: STUDY WITH MIKU web version cover](https://github.com/WenqiOfficial/StudyWithMiku) 。
	- 部署参考并使用该 [GitHub - XTLS/Xray-examples: Some examples of uses for Xray-core.](https://github.com/XTLS/Xray-examples)  并使用 [[Xray]]运行。
		- 准备xray程序本体： https://github.com/XTLS/Xray-core
		- 借助该模板会得到用于 [[Xray]] 和 [[Nginx]] 运行的配置文件，请妥善保存在适合的地方。
	- 需要有一个自己的域名并能通过 [[CloudFlare]] 管理DNS。
- ## 部署
	- ### 首次运行 [[acme.sh]]创建SSL证书
		- 运行一个acme.sh容器
			- ```shell
			  docker run --rm -itd  \
			    -v "$(pwd)/out":/acme.sh  \
			    --net=host \
			    --name=acme.sh \
			  neilpang/acme.sh daemon
			  ```
		- 进入容器内部： `docker exec -it acme.sh sh`
			- 注册在 [[acme.sh]] 用于申请证书的ZeroSSL提供商： `acme.sh  --register-account  -m xxxxxx@xxxxxx.com --server zerossl`
			- 配置域名DNS配置，例如： [[CloudFlare]]
				- ```shell
				  export CF_Key="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
				  export CF_Email="xxxxxx@xxxxxx.com"
				  ```
			- 通过DNS方式生成证书：
				- ```shell
				  acme.sh  --issue -d exmple.domain.com  --dns dns_cf
				  ```
			- 安装证书
				- ```shell
				  mkdir -p /acme.sh/keyfile/in/nginx /acme.sh/fullchain/nginx #创建证书输出目录
				  
				  acme.sh --install-cert -d exmple.domain.com \
				  --key-file       /acme.sh/keyfile/in/nginx/key.pem  \
				  --fullchain-file /acme.sh/fullchain/nginx/cert.pem \
				  --reloadcmd     "service nginx force-reload"
				  ```
			- 续签证书：确保 [[Docker]]的 [[acme.sh]]容器持续运行， [[acme.sh]]会自动续签，需要注意的是续签后nginx服务要重新启动，方式：再次运行一个容器
				- ```shell
				  docker run -itd  \
				    -v "$(pwd)/out":/acme.sh  \
				    --net=host \
				  neilpang/acme.sh daemon
				  ```
	- ### 创建 [[WARP]]服务并通过[[socks]]使用
		- 借助 [GitHub - baby9/wgcf-socks-docker: Cloudflare WARP (WireGaurd protocol) run in containerized environment.](https://github.com/baby9/wgcf-socks-docker) 提供。
			- ```shell
			  docker run -d \
			    -p 40001:40001 \ # Socks5 proxy server listening on port 40001.
			    -p 40002:40002 \ # HTTP proxy server listening on port 40002. 
			    --restart=unless-stopped \
			  zenexas/wgcf-socks:latest
			  ```
	- ### 一个依赖Linux环境的细节
		- ```shell
		  docker run -d --name unix \
		    -v xrayunix:/dev/shm \
		  alpine rm /dev/shm/*
		  ```
		- 这里的 `xrayunix` 指向的是 [[Xray]] 和 [[Nginx]] 共同需要的 *Unix域套接字地址* 目录，因为这个空间 `/dev/shm` 是在 [[Linux]] 系统的内存中，所以为了保持这个空间在下面两个服务运行前是干净的，需要一个 *真实* 的 [[Linux]] 容器来自动处理它。
	- ### 运行 [[Xray]] 服务并在配置中加入 [[WARP]] 服务
		- 运行 [[Xray]]容器
			- ```shell
			  docker run -d --name xray \
			    --network host \
			    --restart=always \
			    -v xrayunix:/dev/shm \ # Unix域套接字地址
			    -v $PWD/xray:/etc/xray \ # xray 配置文件目录
			    -v $PWD/out:/out \ # acme.sh 生成证书的目录
			  teddysun/xray
			  ```
		- [[Xray]]配置文件中加入 [[WARP]] [[socks]] 参考配置（参考包括将openai、网飞、谷歌服务加入路由规则）
			- ```json
			  {
			      "outbounds": [
			          {
			              "protocol": "socks",
			              "settings": {
			                  "servers": [
			                      {
			                          "address": "127.0.0.1",
			                          "port": 40001
			                      }
			                  ]
			              },
			              "tag": "warp_socks_out"
			          },
			          {
			              "protocol": "freedom",
			              "proxySettings": {
			                  "tag": "warp_socks_out"
			              },
			              "settings": {
			                  "domainStrategy": "UseIPv4"
			              },
			              "tag": "WARP-socks5-v4"
			          },
			          {
			              "protocol": "freedom",
			              "proxySettings": {
			                  "tag": "warp_socks_out"
			              },
			              "settings": {
			                  "domainStrategy": "UseIPv6"
			              },
			              "tag": "WARP-socks5-v6"
			          }
			      ],
			      "rules": [
			          {
			              "domain": [
			                  "geosite:openai",
			                  "ip.gs",
			                  "ip.sb"
			              ],
			              "outboundTag": "warp_socks_out",
			              "type": "field"
			          },
			          {
			              "domain": [
			                  "geosite:google",
			                  "geosite:netflix"
			              ],
			              "outboundTag": "WARP-socks5-v6",
			              "type": "field"
			          }
			      ]
			  }
			  ```
	- ### 运行 [[Nginx]]
		- 运行 [[Nginx]]容器
			- ```shell
			  docker run -d --name nginx \
			    --network host \
			    --restart=always \
			    -v xrayunix:/dev/shm \ # Unix域套接字地址
			    -v $PWD/html:/var/www/html \ # 静态页面目录
			    -v $PWD/nginx.server.conf/:/etc/nginx/conf.d \ # nginx 配置文件目录
			  nginx
			  ```
- ## [[Docker Compose]]
	- Docker Compose文件请在首次通过以上部署环节后使用，用于后续使用。
	- ```yaml
	  version: '3'
	  services:
	      unix:
	          volumes:
	              - 'xrayunix:/dev/shm'
	          image: alpine
	          command: 'rm /dev/shm/*'
	  
	      wgcf-socks:
	          ports:
	              - '127.0.0.1:40001:40001'
	          restart: unless-stopped
	          image: 'zenexas/wgcf-socks:latest'
	  
	      xray:
	          network_mode: host
	          restart: always
	          volumes:
	              - 'xrayunix:/dev/shm'
	              - './xray:/etc/xray'
	              - './out:/out'
	          image: teddysun/xray
	          depends_on:
	              - wgcf-socks
	              - unix
	  
	      acme.sh:
	          volumes:
	              - './out:/acme.sh'
	          network_mode: host
	          image: neilpang/acme.sh
	          command: daemon
	  
	      nginx:
	          network_mode: host
	          restart: always
	          volumes:
	              - 'xrayunix:/dev/shm'
	              - './html:/var/www/html'
	              - './nginx.server.conf/:/etc/nginx/conf.d'
	              - '/etc/localtime:/etc/localtime'
	          image: nginx
	          depends_on:
	              - xray
	              - acme.sh
	  
	  volumes:
	      xrayunix:
	  ```
- ## 维护&Debug
	- 该项目维护&Debug文档移至此处：[[项目01维护手册]]